openapi: "3.0.1"
info:
    title: "trip-carrier-advance-api"
    version: "1.0"
    description: "trip-carrier-advance-api"
servers:
    - url: "{server}/v1"
paths:
    /advance_payment/request_give_advance_payment/{id}:
        post:
            security:
                -   bearerAuth: []
            summary: "Запрос на выдачу аванса"
            operationId: requestGiveAdvancePayment
            tags:
                - Advance Payment
            parameters:
                -   name: id
                    in: path
                    description: "ID перевозки"
                    required: true
                    schema:
                        type: integer
                        format: int64
                        minimum: 1
            responses:
                200:
                    description: "OK"
                default:
                    description: "Some other error"
                    content:
                        application/json:
                            schema:
                                $ref: "#/components/schemas/Error"
                422:
                    description: "Business error"
                    content:
                        application/json:
                            schema:
                                $ref: "#/components/schemas/Error"

    /advance_payment/confirm_advance_payment/{id}:
        post:
            security:
                -   bearerAuth: []
            summary: "Подтверждение аванса"
            operationId: confirmAdvancePayment
            tags:
                - Advance Payment
            parameters:
                -   name: id
                    in: path
                    description: "ID запроса на авансирование"
                    required: true
                    schema:
                        type: integer
                        format: int64
                        minimum: 1
            #                -   name: is_success
            #                    in: query
            #                    description: "Флаг подтверждения выдачи аванса"
            #                    required: false
            #                    schema:
            #                        type: boolean
            #                        default: false

            responses:
                200:
                    description: "OK"
                default:
                    description: "Some other error"
                    content:
                        application/json:
                            schema:
                                $ref: "#/components/schemas/Error"
                422:
                    description: "Business error"
                    content:
                        application/json:
                            schema:
                                $ref: "#/components/schemas/Error"

    /advance_payment/is_advanced/{trip_id}:
        get:
            security:
                -   bearerAuth: []
            summary: "Проверить выдан ли аванс"
            operationId: isAdvanced
            tags:
                - Advance Payment
            parameters:
                -   name: trip_id
                    in: path
                    description: "Id заказа на перевозку"
                    required: true
                    schema:
                        type: integer
                        format: int64
                        minimum: 1
            responses:
                200:
                    description: "OK"
                    content:
                        application/json:
                            schema:
                                $ref: "#/components/schemas/isAdvancedRequestResponse"
                default:
                    description: "Some other error"
                    content:
                        application/json:
                            schema:
                                $ref: "#/components/schemas/Error"
                422:
                    description: "Business error"
                    content:
                        application/json:
                            schema:
                                $ref: "#/components/schemas/Error"

    /advance_payment/search_request:
        post:
            security:
                -   bearerAuth: []
            summary: "Просмотр списка запросов на аванс"
            operationId: searchAdvancePaymentRequest
            tags:
                - Advance Payment
            requestBody:
                content:
                    application/json:
                        schema:
                            $ref: '#/components/schemas/Filter'
            responses:
                200:
                    description: "OK"
                    content:
                        application/json:
                            schema:
                                $ref: '#/components/schemas/ResponseAdvancePayment'
                default:
                    description: "Some other error"
                    content:
                        application/json:
                            schema:
                                $ref: "#/components/schemas/Error"
                422:
                    description: "Business error"
                    content:
                        application/json:
                            schema:
                                $ref: "#/components/schemas/Error"

    /advance_payment/contact/get_contact_carrier/{contrctor_id}:
        get:
            security:
                -   bearerAuth: []
            summary: "Просмотр контактов перевозчика"
            operationId: getContactCarrier
            tags:
                - Cotractor
            parameters:
                -   name: contrctor_id
                    in: path
                    schema:
                        type: integer
                        format: int64
                    required: true
            responses:
                200:
                    description: "OK"
                    content:
                        application/json:
                            schema:
                                $ref: "#/components/schemas/CarrierContactDTO"
                default:
                    description: "Some other error"
                    content:
                        application/json:
                            schema:
                                $ref: "#/components/schemas/Error"
                422:
                    description: "Business error"
                    content:
                        application/json:
                            schema:
                                $ref: "#/components/schemas/Error"

    /advance_payment/contact/update_contact_carrier:
        put:
            security:
                -   bearerAuth: []
            summary: "Обновить контакт контрагента для авансирования"
            operationId: updateContactCarrier
            tags:
                - Cotractor
            requestBody:
                content:
                    application/json:
                        schema:
                            $ref: "#/components/schemas/CarrierContactDTO"
            responses:
                200:
                    description: "OK"
                default:
                    description: "Some other error"
                    content:
                        application/json:
                            schema:
                                $ref: "#/components/schemas/Error"
                422:
                    description: "Business error"
                    content:
                        application/json:
                            schema:
                                $ref: "#/components/schemas/Error"

    /advance_payment/contact/add_contact_carrier:
        post:
            security:
                -   bearerAuth: []
            summary: "Добавить контакт контрагента для авансирования"
            operationId: addContactCarrier
            tags:
                - Cotractor
            requestBody:
                content:
                    application/json:
                        schema:
                            $ref: "#/components/schemas/CarrierContactDTO"
            responses:
                200:
                    description: "OK"
                default:
                    description: "Some other error"
                    content:
                        application/json:
                            schema:
                                $ref: "#/components/schemas/Error"
                422:
                    description: "Business error"
                    content:
                        application/json:
                            schema:
                                $ref: "#/components/schemas/Error"

    /advance_payment/update_loading_complete:
        put:
            security:
                -   bearerAuth: []
            summary: "Обновить факт загрузки водителя"
            operationId: updateLoadingComplete
            tags:
                - Advance Payment
            parameters:
                -   name: id
                    in: query
                    schema:
                        type: integer
                        format: int64
                    required: true
                    description: "Номер запроса на аванс"
                -   name: loading_complete
                    in: query
                    schema:
                        type: boolean
                    required: true
                    description: "Флаг загрузился водитель"
            responses:
                200:
                    description: "OK"
                default:
                    description: "Some other error"
                    content:
                        application/json:
                            schema:
                                $ref: "#/components/schemas/Error"
                422:
                    description: "Business error"
                    content:
                        application/json:
                            schema:
                                $ref: "#/components/schemas/Error"

    /advance_payment/cancel_advance_payment:
        put:
            security:
                -   bearerAuth: []
            summary: "Аннулировать запрос на аванс "
            operationId: cancelAdvancePayment
            tags:
                - Advance Payment
            parameters:
                -   name: id
                    in: query
                    schema:
                        type: integer
                        format: int64
                    required: true
                    description: "Номер запроса на аванс"
                -   name: cancelled_comment
                    in: query
                    schema:
                        type: string
                    required: true
                    description: "Комментарий при отмене аванса"
            responses:
                200:
                    description: "OK"
                default:
                    description: "Some other error"
                    content:
                        application/json:
                            schema:
                                $ref: "#/components/schemas/Error"
                422:
                    description: "Business error"
                    content:
                        application/json:
                            schema:
                                $ref: "#/components/schemas/Error"

    /advance_payment/change_advance_payment_comment:
        put:
            security:
                -   bearerAuth: []
            summary: "Сменить комментарий в авансе"
            operationId: changeAdvancePaymentComment
            tags:
                - Advance Payment
            requestBody:
                content:
                    application/json:
                        schema:
                            $ref: "#/components/schemas/AdvancePaymentCommentDTO"
            responses:
                200:
                    description: "OK"
                default:
                    description: "Some other error"
                    content:
                        application/json:
                            schema:
                                $ref: "#/components/schemas/Error"
                422:
                    description: "Business error"
                    content:
                        application/json:
                            schema:
                                $ref: "#/components/schemas/Error"

    /advance_payment/download_advance_request_template:
        get:
            tags:
                - Application contract
            summary: "Запрос на скачивание шаблонной заявки на аванс"
            operationId: downloadAvanceRequestTemplate
            parameters:
                -   name: trip_num
                    in: query
                    schema:
                        type: string
                    description: "Номер заказа поставщика"
            responses:
                "200":
                    description: "PDF-файл"
                    content:
                        application/pdf:
                            schema:
                                type: string
                                format: binary
                "422":
                    description: "Ошибка в процессе скачивания файла"

    /advance_payment/download_request:
        get:
            tags:
                - Application contract
            summary: "Запрос на скачивание подписанного PDF файла заявки"
            operationId: downloadRequest
            parameters:
                -   name: trip_num
                    in: query
                    schema:
                        type: string
                    description: "Номер заказа поставщика"
            responses:
                "200":
                    description: "PDF-файл"
                    content:
                        application/pdf:
                            schema:
                                type: string
                                format: binary
                "422":
                    description: "Ошибка в процессе скачивания файла"

    /advance_payment/download_request_avance:
        get:
            tags:
                - Application contract
            summary: "Запрос на скачивание подписанного PDF файла заявки на аванс"
            operationId: downloadAvanseRequest
            parameters:
                -   name: trip_num
                    in: query
                    schema:
                        type: string
                    description: "Номер заказа поставщика"
            responses:
                "200":
                    description: "PDF-файл"
                    content:
                        application/pdf:
                            schema:
                                type: string
                                format: binary
                "422":
                    description: "Ошибка в процессе скачивания файла"

    /advance_payment/upload_request_avance:
        post:
            security:
                -   bearerAuth: []
            tags:
                - Application contract
            summary: "Добавление подписанного PDF файла заявки на аванс"
            operationId: uploadRequestAdvance
            parameters:
                -   name: trip_num
                    in: query
                    schema:
                        type: string
                    description: "Номер заказа поставщика"
            requestBody:
                required: true
                content:
                    multipart/form-data:
                        schema:
                            $ref: "#/components/schemas/RequestFormData"
            responses:
                "201":
                    description: "Данные успешно получены"
                "422":
                    description: "Ошибка в процессе получения файла"

    /advance_payment/carrier/request_by_carrier/{uuid}:
        #     без авторизации
        post:
            summary: "Хочу аванс экран поставщика"
            operationId: requestGiveAdvancePaymentForCarrier
            tags:
                - Advance Payment
            parameters:
                -   name: uuid
                    in: path
                    description: "uuid заказа на аванс"
                    required: true
                    schema:
                        type: string
                        format: uuid
            responses:
                200:
                    description: "OK"
                default:
                    description: "Some other error"
                    content:
                        application/json:
                            schema:
                                $ref: "#/components/schemas/Error"
                422:
                    description: "Business error"
                    content:
                        application/json:
                            schema:
                                $ref: "#/components/schemas/Error"

    /advance_payment/carrier/search_request/{uuid}:
        #        без авторизации
        get:
            summary: "Просмотр запроса на аванс для экрана поставщика "
            operationId: searchAdvancePaymentRequestByUuid
            tags:
                - Advance Payment
            parameters:
                -   name: uuid
                    in: path
                    description: "uuid заказа на аванс"
                    required: true
                    schema:
                        type: string
                        format: uuid
            responses:
                200:
                    description: "OK"
                    content:
                        application/json:
                            schema:
                                $ref: '#/components/schemas/FrontAdvancePaymentResponse'
                default:
                    description: "Some other error"
                    content:
                        application/json:
                            schema:
                                $ref: "#/components/schemas/Error"
                422:
                    description: "Business error"
                    content:
                        application/json:
                            schema:
                                $ref: "#/components/schemas/Error"

    /advance_payment/carrier/upload_request_avance_for_carrier:
        #  без авторизации
        post:
            tags:
                - Application contract
            summary: "Добавление подписанного PDF файла заявки на аванс"
            operationId: uploadRequestAvanceForCarrier
            parameters:
                -   name: trip_num
                    in: query
                    schema:
                        type: string
                    description: "Номер заказа поставщика"
            requestBody:
                required: true
                content:
                    multipart/form-data:
                        schema:
                            $ref: "#/components/schemas/RequestFormData"
            responses:
                "201":
                    description: "Данные успешно получены"
                "422":
                    description: "Ошибка в процессе получения файла"

    /advance_payment/carrier/download_advance_request_template_for_carrier:
        get:
            #             без авторизации
            tags:
                - Application contract
            summary: "Запрос на скачивание шаблонной заявки на аванс"
            operationId: downloadAvanceRequestTemplateForCarrier
            parameters:
                -   name: trip_num
                    in: query
                    schema:
                        type: string
                    description: "Номер заказа поставщика"
            responses:
                "200":
                    description: "PDF-файл"
                    content:
                        application/pdf:
                            schema:
                                type: string
                                format: binary
                "422":
                    description: "Ошибка в процессе скачивания файла"

# Apply the security globally to all operations
security:
    -   bearerAuth: []
components:
    securitySchemes:
        bearerAuth:
            type: http
            scheme: bearer
            bearerFormat: JWT
    schemas:
        Error:
            required:
                - status
                - error_code
                - error_message
            properties:
                status:
                    type: string
                error_code:
                    type: string
                error_message:
                    type: string

        AdvancePaymentCommentDTO:
            type: object
            description: "Комментарий"
            required:
                - id
                - advance_comment
            properties:
                id:
                    type: integer
                    format: int64
                    description: "Номер запроса на аванс"
                advance_comment:
                    type: string
                    description: "Комментарий в авансе"

        ResponseAdvancePayment:
            type: object
            description: "Список запросов на аванс"
            properties:
                total:
                    type: integer
                    format: int32
                    description: "Всего AdvancePayment"
                request_advance_payment:
                    type: array
                    items:
                        $ref: '#/components/schemas/FrontAdvancePaymentResponse'

        FrontAdvancePaymentResponse:
            type: object
            description: "Аванс"
            properties:
                id:
                    type: integer
                    format: int64
                    description: "ID запроса на авансирование"
                trip_id:
                    type: integer
                    format: int64
                    description: "ID перевозки"
                trip_num:
                    type: string
                    description: "Номер перевозки"
                trip_type_code:
                    type: string
                    description: "Тип перевозки"
                created_at:
                    type: string
                    format: date-time
                    description: "Дата создания заказа поставщика"
                push_button_at:
                    type: string
                    format: date-time
                    description: "Дата и время нажатия на кнопку"
                author_id:
                    type: integer
                    format: int64
                    description: "Инициатор запроса на авансирование"
                contractor_id:
                    type: integer
                    format: int64
                    description: "Исполнитель"
                contractor_name:
                    type: string
                    description: "Исполнитель наименование"
                contact_fio:
                    type: string
                    description: "Контакты исполнителя ФИО"
                contact_email:
                    type: string
                    description: "Контакты исполнителя Почта"
                contact_phone:
                    type: string
                    description: "Контакты исполнителя Телефон"
                payment_contractor:
                    type: string
                    description: "От кого везём"
                req_created_at:
                    type: string
                    format: date-time
                    description: "Время запроса аванса"
                is_automation_request:
                    type: boolean
                    description: "Признак автоматической выдачи аванса"
                trip_cost_with_vat:
                    type: number
                    format: double
                    description: "Стоимость перевозки с НДС"
                advance_payment_sum:
                    type: number
                    format: double
                    description: "Сумма аванса"
                registration_fee:
                    type: number
                    format: double
                    description: "Сбор за оформление документов"
                loading_complete:
                    type: boolean
                    description: "Водитель загрузился"
                url_contract_application:
                    type: string
                    description: "Ссылка на скачивание «Договор-заявка» или «Заявка»"
                url_advance_application:
                    type: string
                    description: "Ссылка на скачивание заявки на авансирование"
                is_1C_send_allowed:
                    type: boolean
                    description: "Признак доступности отправки в 1с"
                is_pushed_unf_button:
                    type: boolean
                    description: "Признак нажали на кнопку в 1с"
                is_unf_send:
                    type: boolean
                    description: "Признак отправили в УНФ"
                is_paid:
                    type: boolean
                    description: "Оплачен"
                paid_at:
                    type: string
                    format: date-time
                    description: "Дата оплаты"
                comment:
                    type: string
                    description: "Комментарий"
                is_cancelled:
                    type: boolean
                    description: "Признак аннулирован аванс"
                cancelled_comment:
                    type: string
                    description: "Комментарий к аннулированию аванса"
                page_carrier_url_is_access:
                    type: boolean
                    description: "Признак доступности ссылки в кабинет перевозчика "
                first_loading_address:
                    type: string
                    description: "Адрес первой погрузки"
                last_unloading_address:
                    type: string
                    description: "Адрес последней разгрузки"
                loading_date:
                    type: string
                    format: date-time
                    description: "Дата погрузки"
                loading_tz:
                    type: string
                    description: "Таймзона погрузки"
                unloading_date:
                    type: string
                    format: date-time
                    description: "Дата разгрузки"
                unloading_tz:
                    type: string
                    description: "Таймзона разгрузки"
        ContractorResponse:
            type: array
            items:
                $ref: "#/components/schemas/ContractorDTO"

        ContractorDTO:
            type: object
            properties:
                id:
                    type: integer
                    format: int32
                    description: "ID контрагента"
                full_name:
                    type: string
                    description: "Наименование"
                inn:
                    type: string
                    description: "ИНН"

        CarrierContactDTO:
            type: object
            description: Персональные данные
            required:
                - contractor_id
                - full_name
                - phone
                - email
            properties:
                contractor_id:
                    type: integer
                    format: int64
                    description: "ID"
                full_name:
                    type: string
                    description: "Фамилия Имя Отчество"
                phone_number:
                    type: string
#                    pattern: "^+),-,0-9*$"
                    minLength: 8
                    maxLength: 19
                    example: "9851112233"
                    description: "Номер телефона"
                email:
                    type: string
                    description: "Почта"
                    example: user@example.com
                    format: email

        Filter:
            type: object
            properties:
                is_paid:
                    type: boolean
                    description: "Признак - Оплачен"
                is_cancelled:
                    type: boolean
                    description: "Признак - Отменен"
                has_comment:
                    type: boolean
                    description: "Признак - Есть комменарий"
                is_downloaded_contract_application:
                    type: boolean
                    description: "Признак - загружен «Договор-заявка» или «Заявка»"
                is_downloaded_advance_application:
                    type: boolean
                    description: "Признак - загружена заявка на авансирование"
                is_pushed_unf_button:
                    type: boolean
                    description: "Признак - отправлен в УНФ"
                is_unf_send:
                    type: boolean
                    description: "Загружен в УНФ"
                page:
                    type: integer
                    format: int32
                    default: 1
                    description: "Позиция, с которой отдаются результаты"
                perPage:
                    type: integer
                    format: int32
                    default: 10
                    description: "Количество возвращаемых результатов"
                sort:
                    type: array
                    items:
                        $ref: "#/components/schemas/SortBy"

        SortBy:
            required:
                - key
                - dir
            properties:
                key:
                    #                    type: string
                    $ref: '#/components/schemas/SortByField'
                dir:
                    #                    type: string
                    $ref: '#/components/schemas/SortByDirection'

        SortByField:
            type: string
            enum:
                - trip_num
                - push_button_at
                - is_automation_request
                - loading_complete
                - is_downloaded_contract_application
                - is_downloaded_advance_application
                - is_pushed_unf_button

        SortByDirection:
            type: string
            enum:
                - asc
                - desc

        isAdvancedRequestResponse:
            type: object
            description: "Статус выдачи аванса"
            properties:
                is_paid:
                    type: boolean
                    description: "Оплачен"
                isButtonActive:
                    type: boolean
                    description: "Доступность выдачи аванса"
                isDownloadedDocs:
                    type: boolean
                    description: "Наличие загруженных документов"
                isContractorLock:
                    type: boolean
                    description: "Признак блокировки контрагента "
                tripTypeCode:
                    type: string
                    description: "Тип заказа нужен фронту для отображения кнопки (пока фронт должен отображать только авто (FTL))"
                authorId:
                    type: integer
                    format: int64
                    description: "Id того кто нажал кнопку \"Выдать аванс\""
                firstName:
                    type: string
                    description: "Имя того кто нажал кнопку \"Выдать аванс\""
                lastName:
                    type: string
                    description: "Фамилия того кто нажал кнопку \"Выдать аванс\""
                middleName:
                    type: string
                    description: "Отчество того кто нажал кнопку \"Выдать аванс\""
                createdAt:
                    type: string
                    format: date-time
                    description: "Время и дата запроса аванса"
                comment:
                    type: string
                    description: "Комментарий"
                isAutoRequested:
                    type: boolean
                    description: "Тип заказа нужен фронту для отображения кнопки (пока фронт должен отображать только авто (FTL))"

        RequestFormData:
            title: "Параметры запроса"
            type: object
            properties:
                filename:
                    type: string
                    format: binary
            required:
                - filename

        ResponseToken:
            type: object
            description: "JWT токены доступа и обновления"
            required:
                - access_token
                - expires_in
                - refresh_expires_in
                - refresh_token
                - token_type
            properties:
                access_token:
                    type: string
                    example: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiaWF0IjoxNTE2MjM5MDIyfQ.SflKxwRJSMeKKF2QT4fwpMeJf36POk6yJV_adQssw5c"
                    description: "Токен доступа"
                expires_in:
                    type: integer
                    format: int32
                    example: 86400
                    description: "Время жизни токена доступа, секунды"
                refresh_expires_in:
                    type: integer
                    format: int32
                    example: 2592000
                    description: "Время жизни токена обновления, секунды"
                refresh_token:
                    type: string
                    example: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiaWF0IjoxNTE2MjM5MDIyfQ.SflKxwRJSMeKKF2QT4fwpMeJf36POk6yJV_adQssw5c"
                token_type:
                    type: string
                    example: "Bearer"
                    description: "Тип токена"
